import { HttpParams } from '@angular/common/http';
import { LocalDataSource } from '../local/local.data-source';
import { ServerSourceConf } from './server-source.conf';
import { getDeepFromObject } from '../../helpers';
import { map } from 'rxjs/operators';
export class ServerDataSource extends LocalDataSource {
    constructor(http, conf = {}) {
        super();
        this.http = http;
        this.lastRequestCount = 0;
        this.conf = new ServerSourceConf(conf);
        if (!this.conf.endPoint) {
            throw new Error('At least endPoint must be specified as a configuration of the server data source.');
        }
    }
    count() {
        return this.lastRequestCount;
    }
    getElements() {
        return this.requestElements()
            .pipe(map(res => {
            this.lastRequestCount = this.extractTotalFromResponse(res);
            this.data = this.extractDataFromResponse(res);
            return this.data;
        })).toPromise();
    }
    /**
     * Extracts array of data from server response
     * @param res
     * @returns {any}
     */
    extractDataFromResponse(res) {
        const rawData = res.body;
        const data = !!this.conf.dataKey ? getDeepFromObject(rawData, this.conf.dataKey, []) : rawData;
        if (data instanceof Array) {
            return data;
        }
        return [];
    }
    /**
     * Extracts total rows count from the server response
     * Looks for the count in the heders first, then in the response body
     * @param res
     * @returns {any}
     */
    extractTotalFromResponse(res) {
        if (res.headers.has(this.conf.totalKey)) {
            return +res.headers.get(this.conf.totalKey);
        }
        else {
            const rawData = res.body;
            return getDeepFromObject(rawData, this.conf.totalKey, 0);
        }
    }
    requestElements() {
        if (this.isRequestValid()) {
            let httpParams = this.createRequesParams();
            return this.http.get(this.conf.endPoint, { params: httpParams, observe: 'response' });
        }
        return null;
    }
    /*
    the request is valid when:
    (a) only one filter item available
    (b) only one sort item available
    (c) when both filter item and sort item available they must be associated with the same key
    */
    isRequestValid() {
        let filterField = '';
        let filterCounter = 0;
        if (this.filterConf.filters) {
            this.filterConf.filters.forEach((fieldConf) => {
                if (fieldConf['search']) {
                    filterField = fieldConf['field'];
                    filterCounter += 1;
                    if (filterCounter > 1) {
                        return false;
                    }
                }
            });
        }
        let sortKey = '';
        let sortCounter = 0;
        if (this.sortConf) {
            this.sortConf.forEach((fieldConf) => {
                sortKey = fieldConf.field;
                sortCounter += 1;
                if (sortCounter > 1) {
                    return false;
                }
            });
            if (filterCounter == 1 && sortCounter == 1 && filterField !== sortKey) {
                return false;
            }
        }
        return true;
    }
    createRequesParams() {
        let httpParams = new HttpParams();
        httpParams = this.addSortRequestParams(httpParams);
        httpParams = this.addFilterRequestParams(httpParams);
        return this.addPagerRequestParams(httpParams);
    }
    addSortRequestParams(httpParams) {
        if (this.sortConf) {
            this.sortConf.forEach((fieldConf) => {
                httpParams = httpParams.set(this.conf.sortFieldKey, fieldConf.field);
                httpParams = httpParams.set(this.conf.sortDirKey, fieldConf.direction.toUpperCase());
            });
        }
        return httpParams;
    }
    addFilterRequestParams(httpParams) {
        if (this.filterConf.filters) {
            this.filterConf.filters.forEach((fieldConf) => {
                if (fieldConf['search']) {
                    httpParams = httpParams.set(this.conf.filterFieldKey.replace('#field#', fieldConf['field']), fieldConf['search']);
                }
            });
        }
        return httpParams;
    }
    addPagerRequestParams(httpParams) {
        if (this.pagingConf && this.pagingConf['page'] && this.pagingConf['perPage']) {
            httpParams = httpParams.set(this.conf.pagerPageKey, this.pagingConf['page']);
            httpParams = httpParams.set(this.conf.pagerLimitKey, this.pagingConf['perPage']);
        }
        return httpParams;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy93ZWUvV29yay9zb2xpZHVzL25nMi1tb2UtdG1wL25nMi1zbWFydC10YWJsZS1zcmMvcHJvamVjdHMvbmcyLXNtYXJ0LXRhYmxlL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9saWIvZGF0YS1zb3VyY2Uvc2VydmVyL3NlcnZlci5kYXRhLXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHOUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVsRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsTUFBTSxPQUFPLGdCQUFpQixTQUFRLGVBQWU7SUFNbkQsWUFBc0IsSUFBZ0IsRUFBRSxPQUE4QixFQUFFO1FBQ3RFLEtBQUssRUFBRSxDQUFDO1FBRFksU0FBSSxHQUFKLElBQUksQ0FBWTtRQUY1QixxQkFBZ0IsR0FBVyxDQUFDLENBQUM7UUFLckMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXZDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLG1GQUFtRixDQUFDLENBQUM7U0FDdEc7SUFDSCxDQUFDO0lBRUQsS0FBSztRQUNILE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDO0lBQy9CLENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFO2FBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDZCxJQUFJLENBQUMs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LEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2lCQUNuSDtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRVMscUJBQXFCLENBQUMsVUFBc0I7UUFFcEQsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUM1RSxVQUFVLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDN0UsVUFBVSxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1NBQ2xGO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgTG9jYWxEYXRhU291cmNlIH0gZnJvbSAnLi4vbG9jYWwvbG9jYWwuZGF0YS1zb3VyY2UnO1xuaW1wb3J0IHsgU2VydmVyU291cmNlQ29uZiB9IGZyb20gJy4vc2VydmVyLXNvdXJjZS5jb25mJztcbmltcG9ydCB7IGdldERlZXBGcm9tT2JqZWN0IH0gZnJvbSAnLi4vLi4vaGVscGVycyc7XG5cbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IGNsYXNzIFNlcnZlckRhdGFTb3VyY2UgZXh0ZW5kcyBMb2NhbERhdGFTb3VyY2Uge1xuXG4gIHByb3RlY3RlZCBjb25mOiBTZXJ2ZXJTb3VyY2VDb25mO1xuXG4gIHByb3RlY3RlZCBsYXN0UmVxdWVzdENvdW50OiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50LCBjb25mOiBTZXJ2ZXJTb3VyY2VDb25mIHwge30gPSB7fSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmNvbmYgPSBuZXcgU2VydmVyU291cmNlQ29uZihjb25mKTtcblxuICAgIGlmICghdGhpcy5jb25mLmVuZFBvaW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0IGxlYXN0IGVuZFBvaW50IG11c3QgYmUgc3BlY2lmaWVkIGFzIGEgY29uZmlndXJhdGlvbiBvZiB0aGUgc2VydmVyIGRhdGEgc291cmNlLicpO1xuICAgIH1cbiAgfVxuXG4gIGNvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMubGFzdFJlcXVlc3RDb3VudDtcbiAgfVxuXG4gIGdldEVsZW1lbnRzKCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdEVsZW1lbnRzKClcbiAgICAgIC5waXBlKG1hcChyZXMgPT4ge1xuICAgICAgICB0aGlzLmxhc3RSZXF1ZXN0Q291bnQgPSB0aGlzLmV4dHJhY3RUb3RhbEZyb21SZXNwb25zZShyZXMpO1xuICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLmV4dHJhY3REYXRhRnJvbVJlc3BvbnNlKHJlcyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgICAgIH0pKS50b1Byb21pc2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0cyBhcnJheSBvZiBkYXRhIGZyb20gc2VydmVyIHJlc3BvbnNlXG4gICAqIEBwYXJhbSByZXNcbiAgICogQHJldHVybnMge2FueX1cbiAgICovXG4gIHByb3RlY3RlZCBleHRyYWN0RGF0YUZyb21SZXNwb25zZShyZXM6IGFueSk6IEFycmF5PGFueT4ge1xuICAgIGNvbnN0IHJhd0RhdGEgPSByZXMuYm9keTtcbiAgICBjb25zdCBkYXRhID0gISF0aGlzLmNvbmYuZGF0YUtleSA/IGdldERlZXBGcm9tT2JqZWN0KHJhd0RhdGEsIHRoaXMuY29uZi5kYXRhS2V5LCBbXSkgOiByYXdEYXRhO1xuXG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIHJldHVybiBbXVxuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3RzIHRvdGFsIHJvd3MgY291bnQgZnJvbSB0aGUgc2VydmVyIHJlc3BvbnNlXG4gICAqIExvb2tzIGZvciB0aGUgY291bnQgaW4gdGhlIGhlZGVycyBmaXJzdCwgdGhlbiBpbiB0aGUgcmVzcG9uc2UgYm9keVxuICAgKiBAcGFyYW0gcmVzXG4gICAqIEByZXR1cm5zIHthbnl9XG4gICAqL1xuICBwcm90ZWN0ZWQgZXh0cmFjdFRvdGFsRnJvbVJlc3BvbnNlKHJlczogYW55KTogbnVtYmVyIHtcbiAgICBpZiAocmVzLmhlYWRlcnMuaGFzKHRoaXMuY29uZi50b3RhbEtleSkpIHtcbiAgICAgIHJldHVybiArcmVzLmhlYWRlcnMuZ2V0KHRoaXMuY29uZi50b3RhbEtleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJhd0RhdGEgPSByZXMuYm9keTtcbiAgICAgIHJldHVybiBnZXREZWVwRnJvbU9iamVjdChyYXdEYXRhLCB0aGlzLmNvbmYudG90YWxLZXksIDApO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCByZXF1ZXN0RWxlbWVudHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy5pc1JlcXVlc3RWYWxpZCgpKSB7XG4gICAgICBsZXQgaHR0cFBhcmFtcyA9IHRoaXMuY3JlYXRlUmVxdWVzUGFyYW1zKCk7XG4gICAgICByZXR1cm4gdGhpcy5odHRwLmdldCh0aGlzLmNvbmYuZW5kUG9pbnQsIHsgcGFyYW1zOiBodHRwUGFyYW1zLCBvYnNlcnZlOiAncmVzcG9uc2UnIH0pO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qXG4gIHRoZSByZXF1ZXN0IGlzIHZhbGlkIHdoZW46XG4gIChhKSBvbmx5IG9uZSBmaWx0ZXIgaXRlbSBhdmFpbGFibGVcbiAgKGIpIG9ubHkgb25lIHNvcnQgaXRlbSBhdmFpbGFibGVcbiAgKGMpIHdoZW4gYm90aCBmaWx0ZXIgaXRlbSBhbmQgc29ydCBpdGVtIGF2YWlsYWJsZSB0aGV5IG11c3QgYmUgYXNzb2NpYXRlZCB3aXRoIHRoZSBzYW1lIGtleVxuICAqL1xuICBpc1JlcXVlc3RWYWxpZCgpOiBib29sZWFuIHtcbiAgICBsZXQgZmlsdGVyRmllbGQgPSAnJztcbiAgICBsZXQgZmlsdGVyQ291bnRlciA9IDA7XG5cbiAgICBpZiAodGhpcy5maWx0ZXJDb25mLmZpbHRlcnMpIHtcbiAgICAgIHRoaXMuZmlsdGVyQ29uZi5maWx0ZXJzLmZvckVhY2goKGZpZWxkQ29uZjogYW55KSA9PiB7XG4gICAgICAgIGlmIChmaWVsZENvbmZbJ3NlYXJjaCddKSB7XG4gICAgICAgICAgZmlsdGVyRmllbGQgPSBmaWVsZENvbmZbJ2ZpZWxkJ107XG4gICAgICAgICAgZmlsdGVyQ291bnRlciArPSAxXG4gICAgICAgICAgaWYgKGZpbHRlckNvdW50ZXIgPiAxKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsZXQgc29ydEtleSA9ICcnO1xuICAgIGxldCBzb3J0Q291bnRlciA9IDA7XG4gICAgaWYgKHRoaXMuc29ydENvbmYpIHtcbiAgICAgIHRoaXMuc29ydENvbmYuZm9yRWFjaCgoZmllbGRDb25mKSA9PiB7XG4gICAgICAgIHNvcnRLZXkgPSBmaWVsZENvbmYuZmllbGQ7XG4gICAgICAgIHNvcnRDb3VudGVyICs9IDFcbiAgICAgICAgaWYgKHNvcnRDb3VudGVyID4gMSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGlmIChmaWx0ZXJDb3VudGVyID09IDEgJiYgc29ydENvdW50ZXIgPT0gMSAmJiBmaWx0ZXJGaWVsZCAhPT0gc29ydEtleSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJlcXVlc1BhcmFtcygpOiBIdHRwUGFyYW1zIHtcbiAgICBsZXQgaHR0cFBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XG5cbiAgICBodHRwUGFyYW1zID0gdGhpcy5hZGRTb3J0UmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zKTtcbiAgICBodHRwUGFyYW1zID0gdGhpcy5hZGRGaWx0ZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXMpO1xuICAgIHJldHVybiB0aGlzLmFkZFBhZ2VyUmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRTb3J0UmVxdWVzdFBhcmFtcyhodHRwUGFyYW1zOiBIdHRwUGFyYW1zKTogSHR0cFBhcmFtcyB7XG4gICAgaWYgKHRoaXMuc29ydENvbmYpIHtcbiAgICAgIHRoaXMuc29ydENvbmYuZm9yRWFjaCgoZmllbGRDb25mKSA9PiB7XG4gICAgICAgIGh0dHBQYXJhbXMgPSBodHRwUGFyYW1zLnNldCh0aGlzLmNvbmYuc29ydEZpZWxkS2V5LCBmaWVsZENvbmYuZmllbGQpO1xuICAgICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLnNvcnREaXJLZXksIGZpZWxkQ29uZi5kaXJlY3Rpb24udG9VcHBlckNhc2UoKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaHR0cFBhcmFtcztcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRGaWx0ZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXM6IEh0dHBQYXJhbXMpOiBIdHRwUGFyYW1zIHtcblxuICAgIGlmICh0aGlzLmZpbHRlckNvbmYuZmlsdGVycykge1xuICAgICAgdGhpcy5maWx0ZXJDb25mLmZpbHRlcnMuZm9yRWFjaCgoZmllbGRDb25mOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGZpZWxkQ29uZlsnc2VhcmNoJ10pIHtcbiAgICAgICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLmZpbHRlckZpZWxkS2V5LnJlcGxhY2UoJyNmaWVsZCMnLCBmaWVsZENvbmZbJ2ZpZWxkJ10pLCBmaWVsZENvbmZbJ3NlYXJjaCddKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGh0dHBQYXJhbXM7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWRkUGFnZXJSZXF1ZXN0UGFyYW1zKGh0dHBQYXJhbXM6IEh0dHBQYXJhbXMpOiBIdHRwUGFyYW1zIHtcblxuICAgIGlmICh0aGlzLnBhZ2luZ0NvbmYgJiYgdGhpcy5wYWdpbmdDb25mWydwYWdlJ10gJiYgdGhpcy5wYWdpbmdDb25mWydwZXJQYWdlJ10pIHtcbiAgICAgIGh0dHBQYXJhbXMgPSBodHRwUGFyYW1zLnNldCh0aGlzLmNvbmYucGFnZXJQYWdlS2V5LCB0aGlzLnBhZ2luZ0NvbmZbJ3BhZ2UnXSk7XG4gICAgICBodHRwUGFyYW1zID0gaHR0cFBhcmFtcy5zZXQodGhpcy5jb25mLnBhZ2VyTGltaXRLZXksIHRoaXMucGFnaW5nQ29uZlsncGVyUGFnZSddKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaHR0cFBhcmFtcztcbiAgfVxufVxuIl19